# Средство загрузки данных и метаданных Государственного Адресного Реестра (ГАР и ФИАС) в PostgreSQL

Как сообщается на https://fias.nalog.ru/ :

> **Государственный адресный реестр** — единственный легитимный источник сведений об адресе.
>
> - Легитимность: Обеспечение правовой основы адреса
> - Обязательность: Каждому объекту адресации должен быть присвоен адрес
> - Уникальность: Один и тот же адрес не может быть присвоен нескольким объектам адресации

**ФИАС** - Федеральная информационная адресная система - _подмножество данных_ ГАР и один из старых форматов выгрузки данных.

Метаданные определяющие транспортные и смысловые именования полей публикуются по адресу https://fias.nalog.ru/docs/gar_schemas.zip

Указание на наиболее свежие образы данных публикуется по адресу https://fias.nalog.ru/WebServices/Public/GetLastDownloadFileInfo в формате JSON.
Адрес полного образа для ручного скачивания (ок. 50Гб на 2026 г.) указан в ветви `GarXMLFullURL`.
Адрес разностного образа для автоматичесокго скачивания указан в ветви `GarXMLDeltaURL`.

# Общий ход процесса загрузки данных

1. Создать БД для ГАР
2. скачать официальные метаданные
3. создать по ним таблицы
4. при желании перенаправить перенос на свои таблицы с иными названиями полей
5. Скачать полный или разностный комплект данных ГАР
6. Скомпилировать программу на C что требует наличия в системе пакетов содержащих libxml2 libpq, например, libxml2-dev и libpq-dev
7. Вызвать скомпилированную программу для всех файлов из распакованного архива. Это можно делать последовательно или параллельно в зависимости от допустимой нагрузки на процессор и/или принимающую БД.

# Подготовка PostgreSQL

## Подготоговка БД

Можно использовать отдельные схемы или пространство данных (tablespace), но лучше создать специальную БД. Объём полной загрузки данных ГАР на 2026 год - **370+ Гигабайт**.

От имени административного пользователя СУБД создайте пользователя и/или базу данных для загрузки данных.

```bash
# Пример получения прав административного пользователя СУБД
sudo -u postgres psql -p 5432
```

Команды создания пользователя и БД:

```sql
create user "Государственный адресный реестр" password '...';
create database "Государственный адресный реестр" owner "Государственный адресный реестр";
```

## Создание схемы для метаданных, их загрузка и проверка наличия

```bash
(
cd 'Утилита';
export PGPASSWORD='qwertyuiop'; export PGDATABASE='Государственный адресный реестр'; export PGUSER='Государственный адресный реестр'; export PGPORT=5432;
# Пример загрузки скрипта SQL создающего схему и струтуру для метаданных
cat sql/xsd.sql | psql -e;
# Пример запуска первой сессии загрузки метаданных
./load_xsd.sh;
export PGPASSWORD='';
)
```

## Получение команд на формирование эталонной структуры таблиц

```bash
###### ЗАДАТЬ ПЕРЕМЕННЫЕ ДОСТУПА К POSTGRESQL
# Задать схему, для которой будут генерироваться команды разворачивания
ddf='sql/ГАР_pgDDL.sql';
echo "select 'CREATE SCHEMA \"' || set_config('ГАР.схема', 'public', false) ||'\";'; select ddl from xsd.table_ddl;" | psql -Atq > "$ddf";
# Прочитать сгенерированное
less "$ddf";

# !!! ИСПРАВИТЬ В ТЕКСТЕ ПОВТОРНЫЙ 'Дополнительный № дома 1' на 'Дополнительный № дома 2'

# Исполнить сгенерированное, жолжна создаться схема с таблицами, принимающими данные ГАР
cat "$ddf" | psql -e;
```

# Компиляция программы

Установить нужные заголовочные файлы языка программирования Си.

Напрмиер, для Убунту:
```
sudo apt install libxml2-dev libpq-dev -y
```

Провести компиляцию
```
cd C;
make all;
```

# Загрузка данных

