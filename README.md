# Скоростная загрузка XML данных Государственного Адресного Реестра (ГАР и ФИАС) в PostgreSQL

Программный комплекс на bash, SQL и GNU C для быстрой перегрузки данных XML ГАР
в PostgreSQL при помощи поточной обработки SAX, позволяющий также подготовить
принимающие таблицы соответствующие приказам ФНС.

_Совместимо с любыми версиями PostgreSQL 8+, проверено на метаданных схем XML ГАР от декабря 2025 года._

Текущий CI статус:
<img src="https://github.com/mkgrgis/gos_adres_reestr_2_postgresql/actions/workflows/CI.yml/badge.svg" align="center" alt="CI статус"/>

Как сообщается на https://fias.nalog.ru/ :

> **Государственный адресный реестр** — единственный легитимный источник сведений об адресе.
>
> - Легитимность: Обеспечение правовой основы адреса
> - Обязательность: Каждому объекту адресации должен быть присвоен адрес
> - Уникальность: Один и тот же адрес не может быть присвоен нескольким объектам адресации

[**О правилах формирования официальной адресной строки изданных ГАР**](https://fias.nalog.ru/docs/%D0%9F%D1%80%D0%B0%D0%B2%D0%B8%D0%BB%D0%B0_%D1%84%D0%BE%D1%80%D0%BC%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F_%D0%B0%D0%B4%D1%80%D0%B5%D1%81%D0%BD%D0%BE%D0%B9_%D1%81%D1%82%D1%80%D0%BE%D0%BA%D0%B8.docx)

**ФИАС** - Федеральная информационная адресная система - _подмножество данных_ ГАР и один из старых форматов выгрузки данных.

# Укрупнённое описание процесса загрузки данных

1. Создать БД для ГАР.
2. Скачать официальные метаданные (XSD описания) и раместить их в БД.
3. Создать соответствующие им таблицы в БД (SQL DDL команды, реляционных таблиц больше чем описаний XSD).
4. При желании перенаправить перенос на свои таблицы с иными названиями полей, отредактировав автоматически созданные словари соответствия.
5. Скачать полный или разностный комплект данных ГАР для загрузки.
6. Скомпилировать программу поточного переноса данных на C что требует наличия в системе пакетов содержащих libxml2 libpq, например, libxml2-dev и libpq-dev.
7. Вызвать скомпилированную программу для всех файлов из распакованного архива.

Параметры вызова программы для каждого файла ГАР определяются из словарей метаданных.

Перенос данных можно делать последовательно или параллельно в зависимости от допустимой нагрузки на процессор и/или принимающую БД.

Метаданные определяющие транспортные и смысловые именования полей данных ГАР публикуются по адресу https://fias.nalog.ru/docs/gar_schemas.zip

Указание на наиболее свежие образы загружаемых данных ГАР публикуется
по адресу https://fias.nalog.ru/WebServices/Public/GetLastDownloadFileInfo в формате JSON.
- Адрес полного образа для ручного скачивания (ок. 50Гб на 2026 г.) указан в ветви `GarXMLFullURL`.
- Адрес разностного образа для автоматичесокго скачивания указан в ветви `GarXMLDeltaURL`.

# Подготовка PostgreSQL

## Подготоговка БД

Объём полной загрузки данных ГАР на 2026 год - более **370 Гигабайт**.
Для загрзки этих данных можно использовать отдельные схемы или
пространство данных (tablespace), но лучше создать специальную БД.

От имени административного пользователя СУБД создайте пользователя и/или базу данных для загрузки данных.

```bash
# Пример получения прав административного пользователя СУБД
sudo -u postgres psql -p 5432
```

Команды создания пользователя и БД:

```sql
create user "Государственный адресный реестр" password '...';
create database "Государственный адресный реестр" owner "Государственный адресный реестр";
```

## Создание схемы для метаданных, их загрузка и проверка наличия

```bash
(
cd 'Утилита';
export PGPASSWORD='qwertyuiop';
export PGDATABASE='Государственный адресный реестр';
export PGUSER='Государственный адресный реестр';
export PGPORT=5432;
# Пример загрузки скрипта SQL создающего схему и струтуру для метаданных
cat sql/xsd.sql | psql -e;
# Пример запуска первой сессии загрузки метаданных
./load_xsd.sh;

# Проверка наличия метаданных
echo 'select count(*) n from xsd.transport_files;' | psql -e;
echo 'select count(*) n from xsd.transport_attributes;' | psql -e;
# стираем пароль после использования
export PGPASSWORD='';
)
```

## Формирование эталонной структуры таблиц

```bash
###### ЗАДАТЬ ПЕРЕМЕННЫЕ ДОСТУПА К POSTGRESQL
# Задать схему, для которой будут генерироваться команды разворачивания
# в примере схема data
ddf='sql/ГАР_pgDDL.sql';
echo "select 'CREATE SCHEMA \"' || set_config('ГАР.схема', 'data', false) ||'\";'; select ddl from xsd.table_ddl;" | psql -Atq > "$ddf";
# Прочитать сгенерированное
less "$ddf";
# Исполнить сгенерированное, должна создаться схема с таблицами, принимающими данные ГАР
cat "$ddf" | psql -e;
```

## Автоматическое заполнение и редактирование словарей соответствия



# Компиляция программы

Установить нужные заголовочные файлы языка программирования Си.

Напрмиер, для Убунту:
```
sudo apt install libxml2-dev libpq-dev -y
```

Провести компиляцию
```
cd C;
make all;
```

# Загрузка данных

